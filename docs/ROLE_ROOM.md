# Role Room (TJR)

Этот файл фиксирует, как в проекте принимаются решения через ролевые skills.

## Участники
- `PM` (`product-manager`): цель, scope, приоритет.
- `Architect` (system role): архитектура модулей, extensibility, runtime trade-off.
- `UI/UX` (`ui-ux-engineer`): UX-поток, интерфейсные состояния, ясность сценариев.
- `Black Hat` (`black-hat-critic`): контраргументы и риски провала.
- `Security Officer` (`software-security-officer`): угрозы и security gate.
- `QA` (`qa`): тест-стратегия, regression gate, verdict по качеству.

## Формат на каждый шаг
1. `PM`: что делаем и зачем.
2. `Architect`: как реализуем и как не загнать проект в тупик.
3. `UI/UX`: как это будет работать для пользователя в интерфейсе.
4. `Black Hat`: топ-риски и неудобные вопросы.
5. `Security Officer`: обязательные security-требования.
6. `QA`: что и как проверяем, какой gate.
7. `Decision`: конкретное решение и следующий инженерный шаг.

## Session 001: Авторизация Telegram и источники чатов

### PM
- Цель этапа: дать пользователю рабочий вход в Telegram и получение списка диалогов в окно настроек.
- Scope: login по номеру/коду/2FA, сохранение сессии, выбор чатов.

### Black Hat
- Риск 1: некорректный retry может вызвать flood/ограничения Telegram.
- Риск 2: неочевидный UX при 2FA даст высокий drop-off.
- Риск 3: ручной ввод чатов без валидации создаст ложные ошибки в анализе.

### Security Officer
- Не хранить API Hash в открытом виде в логах.
- Session-файл и чувствительные параметры хранить в защищенном хранилище (минимум ограниченные права файла; целевое решение: Keychain).
- Добавить явный logout/clear-secrets сценарий.

### QA
- Smoke: успешный login, восстановление сессии после перезапуска, чтение минимум 1 чата.
- Negative: неверный код, неверный 2FA, сеть недоступна.
- Regression gate: без прогона smoke+negative релиз этого этапа `no-go`.

### Decision
- Идем дальше с реализацией Telethon auth flow.
- Блокирующие условия этапа:
- обработка 2FA;
- безопасное хранение сессии без утечек в логи;
- smoke+negative тесты перед приемкой.

## Session 002: UI Smoke для окна настроек и сохранения параметров Telegram

### PM
- Цель этапа: подтвердить, что пользователь вводит Telegram-параметры один раз, и они корректно отображаются после повторного открытия.
- Scope: визуальная проверка главного окна и окна настроек, проверка сценария сохранения.

### Black Hat
- Риск 1: формально "тесты зеленые", но без GUI-инициализации тест не отражает реальный UX.
- Риск 2: сохранение может отработать, но summary-статус на главном экране не обновится.
- Риск 3: offscreen smoke не ловит проблемы рендеринга на реальном мониторе (dpi/шрифты/локаль).

### Security Officer
- Учетные параметры действительно сохраняются между сессиями, что повышает удобство, но увеличивает ценность локального конфига как цели атаки.
- Требование на следующий этап: вынести чувствительные параметры (минимум `api_hash`) в Keychain.

### QA
- Выполнен UI smoke в offscreen-режиме:
- prefill полей в `SettingsDialog`;
- сохранение и валидация обновленного `AppConfig`;
- статус Telegram-конфигурации в `MainWindow`.
- Команда прогона:
- `QT_QPA_PLATFORM=offscreen PYTHONPATH=src python -m unittest discover -s tests -p 'test_*.py'`
- Результат: `Ran 5 tests ... OK`.
- Gate: `go with known issues`.

### Decision
- UI smoke пройден.
- Ограничение: это автоматизированный offscreen smoke, не ручной pixel-level тест на реальном macOS экране.
- Следующий блок: интеграция Telethon авторизации + security hardening хранения секретов.

## Session 003: Сборка macOS приложения (`.app`)

### PM
- Цель: получить запускаемый desktop-артефакт для macOS без запуска через терминал.
- Scope: repeatable build script и готовый `TJR.app` в `dist/`.

### Black Hat
- Риск 1: локально собралось, но у пользователя на другой машине сломается из-за отсутствующих зависимостей.
- Риск 2: неподписанный bundle может потребовать обход Gatekeeper.
- Риск 3: без DMG/installer пользовательский путь установки неочевиден.

### Security Officer
- Текущая подпись ад-хок; для внешнего распространения нужен Developer ID signing + notarization.
- До публичного релиза нельзя считать distribution-ready.

### QA
- Проверено создание bundle и валидная структура:
- `dist/TJR.app` существует;
- `Contents/MacOS/TJR` присутствует и executable;
- `Info.plist` содержит `com.tjr.desktop`.
- Gate: `go with known issues` (локальный запуск ок, публичный дистрибьюшн пока без notarization).

### Decision
- Артефакт для запуска на macOS готов: `dist/TJR.app`.
- Следующий релизный шаг (если нужно распространять вне локального Mac): code signing + notarization + DMG.

## Session 004: Логи сканирования, отдельное окно совпадений и склонения

### PM
- Цель: чтобы пользователь видел факт старта поиска, ход обработки сообщений и удобный список найденных релевантных постов.

### Architect
- Решение: разделить на 4 слоя:
- `core/scanner.py` для прохода по сообщениям и логирования;
- `core/matching.py` для лемматизированного матчинга;
- `ui/results_window.py` для отдельного окна совпадений;
- `core/input_parser.py` для единого разбора ввода (`,`/`;`/`newline`).

### UI/UX
- В главном окне кнопка `Проверить чаты` и сразу видимый путь к лог-файлу.
- Отдельное окно `Найденные совпадения` показывает: дату, канал, совпавшие слова, текст, ссылку и score.
- Ссылка открывается двойным кликом, чтобы переход в Telegram был в один шаг.

### Black Hat
- Риск: пользователь решит, что это реальный Telegram scan, хотя на текущем этапе данные демонстрационные.
- Риск: без морфологии fallback на plain-токены ухудшит качество совпадений при отсутствии `pymorphy3`.

### Security Officer
- Логи не должны содержать `api_hash` и другие секреты.
- Нужен следующий security-этап: перенос секрета в Keychain.

### QA
- Покрыть тестами:
- склонения (`директор` vs `директора`);
- формат ввода через запятую/перенос строки;
- smoke сканера и UI-окна.

### Decision
- Фича одобрена к внедрению с обязательным QA-прогоном.

## Session 005: Реальный Telegram scan и ролевой протокол в чате

### PM
- Цель: перейти с демо-скана на реальное чтение сообщений из Telegram по данным пользователя из настроек.
- Доп. требование: в чате всегда показывать процесс принятия решений ролями.

### Architect
- В `core/scanner.py` добавлен dual-mode:
- `real`: Telethon scan при полном наборе API ID/API Hash/phone;
- `demo`: fallback только при полностью пустых Telegram-полях.
- Добавлена парсинг-поддержка источников:
- `@channel`, `https://t.me/channel`, `https://t.me/channel/123`, `https://t.me/c/<id>/<msg_id>`.

### UI/UX
- При real scan приложение запрашивает код Telegram и 2FA пароль через модальные окна.
- Пользователь видит в главном окне путь к логу и статус сканирования.

### Black Hat
- Риск: при частично заполненных Telegram-полях приложение тихо бы скатывалось в demo.
- Мера: теперь это блокирующая ошибка с явным текстом, что нужно заполнить все 3 поля.

### Security Officer
- Логируются факты старта авторизации и скана, но не секреты.
- Остался обязательный следующий шаг: перенос `api_hash` в Keychain.

### QA
- Прогон тестов после переключения на real scan: `Ran 9 tests ... OK`.
- Gate: `go with known issues` (реальный scan есть, но security hardening по Keychain еще не завершен).

### Decision
- Реальный scan включен.
- Ролевой протокол фиксируется и в документе, и в сообщениях чата.

## Session 006: Исключающие фразы, XLSX, кликабельные ссылки, resize колонок

### PM
- Цель: повысить практичность выдачи для реального job-search процесса.
- Scope: антишум-фильтр, экспорт результатов, удобство чтения таблицы.

### Architect
- Добавлен `exclusion_phrases` в модель профиля и pipeline матчинга.
- Если исключающая фраза найдена, сообщение логируется как `Message excluded` и не попадает в выдачу.
- Добавлен экспорт `.xlsx` через `openpyxl`.

### UI/UX
- В `Settings` добавлено поле исключающих фраз.
- В `Results`:
- ссылки кликабельны в один клик;
- ширина столбцов настраивается вручную;
- кнопка `Экспорт в XLSX`.
- Формат ввода позиций и исключений: `/`, `,`, `;`, перенос строки.

### Black Hat
- Риск: агрессивные исключающие фразы могут выбрасывать полезные вакансии.
- Мера: логировать причину исключения и рекомендовать итеративную настройку стоп-фраз.

### Security Officer
- Экспорт в Excel создает локальный файл с потенциально чувствительными данными вакансий.
- Требование: не хранить экспорт в общедоступных папках без необходимости.

### QA
- После изменений выполнен regression: `Ran 15 tests ... OK`.
- UI smoke подтверждает сохранение slash-формата после повторного открытия настроек.

### Decision
- Функционал принят и включен в рабочую сборку.

## Session 007: Brainstorm по точности поиска вакансий и отсечению шума

### PM
- KPI фокус: повысить `precision` в топ-выдаче и снизить долю шумовых сообщений.

### Architect
- Ввести 2-этапный ранжирующий пайплайн:
- Stage 1: rule-based hard filters (вакансия vs не вакансия, exclusion phrases);
- Stage 2: скоринг релевантности (роль, seniority, локация, формат, зарплата, отрасль).

### UI/UX
- Добавить в UI explainability:
- почему сообщение включено;
- почему сообщение исключено;
- быстрые действия `Это шум` / `Это релевантно` для дообучения правил.

### Black Hat
- Критичный шум-класс: `рекомендую кандидата`, `курсы`, `консалтинг`, `ищу работу`.
- Нужны отдельные детекторы intent (hire vs candidate recommendation vs education offer).

### Security Officer
- Для расширенной аналитики избегать отправки контента сообщений во внешние сервисы без явного consent.

### QA
- Добавить датасет регрессионных примеров из реальных каналов:
- positive вакансии;
- negative шум (рекомендации кандидатов, курсы, анонсы).
- Gate по quality: precision@20 не ниже целевого порога.

### Decision
- Следующий этап: внедрить intent-фильтр вакансий и feedback-loop в UI.

## Session 008: UX отчета, исключающие фразы и slash-формат

### PM
- Цель: сделать выдачу пригодной для ежедневного рекрутингового мониторинга.

### Architect
- Добавлено поле `exclusion_phrases` в конфиг и матчер.
- Реализован фильтр `Message excluded` до попадания в выдачу.
- Логи очищаются при каждом новом поиске.

### UI/UX
- В отчете сообщение показывается компактно: 3 строки + кнопка `...`.
- По `...` разворачивается полный текст, повторный клик сворачивает.
- Подсветка найденных слов в тексте сообщения.
- Ссылки кликабельны.
- Ширина столбцов регулируется вручную.
- Добавлен экспорт результатов в `.xlsx`.
- Slash-формат позиций сохраняется при повторном открытии настроек.

### Black Hat
- Риск: слишком жесткие exclusion-фразы могут скрыть полезные вакансии.
- Митигируем через лог причины исключения и постепенную настройку стоп-фраз.

### Security Officer
- Экспорт в `.xlsx` должен храниться в контролируемом месте.

### QA
- Регрессия: `Ran 15 tests ... OK`.
- Сборка `.app` обновлена.

### Decision
- Функционал принят и доступен в рабочем билде.
